#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞

echo "üîÑ –û—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ Breakout Bot..."

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç
echo "1Ô∏è‚É£  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç..."
./stop.sh

# 2. –ü–æ–¥–æ–∂–¥–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ
sleep 2

# 3. –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ API (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –µ—â–µ –∑–∞–ø—É—â–µ–Ω)
echo "2Ô∏è‚É£  –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π..."
curl -X POST http://localhost:8000/api/monitoring/sessions/cleanup 2>/dev/null || echo "   (–°–µ—Ä–≤–µ—Ä —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)"

# 4. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–±–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Python, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –±–æ—Ç–æ–º
echo "3Ô∏è‚É£  –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
ps aux | grep -E "python.*breakout|python.*uvicorn" | grep -v grep | awk '{print $2}' | xargs kill -9 2>/dev/null
echo "   ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# 5. –û—á–∏—Å—Ç–∏—Ç—å PID —Ñ–∞–π–ª—ã
echo "4Ô∏è‚É£  –û—á–∏—Å—Ç–∫–∞ PID —Ñ–∞–π–ª–æ–≤..."
rm -f pids/*.pid 2>/dev/null
echo "   ‚úÖ PID —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"

# 6. –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
sleep 1

# 7. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç
echo "5Ô∏è‚É£  –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
./start.sh

# 8. –ü–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
echo "6Ô∏è‚É£  –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ (5 —Å–µ–∫)..."
sleep 5

# 9. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
echo "7Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π..."
SESSIONS=$(curl -s http://localhost:8000/api/monitoring/sessions | jq 'length' 2>/dev/null || echo "?")
echo "   üìä –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π: $SESSIONS"

if [ "$SESSIONS" = "1" ]; then
    echo "   ‚úÖ –û—Ç–ª–∏—á–Ω–æ! –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è"
elif [ "$SESSIONS" = "0" ]; then
    echo "   ‚ö†Ô∏è  –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π (–¥–≤–∏–∂–æ–∫ –Ω–µ –∑–∞–ø—É—â–µ–Ω?)"
else
    echo "   ‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ $SESSIONS —Å–µ—Å—Å–∏–π (–æ–∂–∏–¥–∞–ª–æ—Å—å 1)"
fi

echo ""
echo "üéâ –ì–æ—Ç–æ–≤–æ!"
echo "   UI: http://localhost:3000"
echo "   API: http://localhost:8000"
